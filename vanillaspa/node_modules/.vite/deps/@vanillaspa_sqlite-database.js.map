{
  "version": 3,
  "sources": ["../../@vanillaspa/sqlite-database/index.js"],
  "sourcesContent": ["import sqlite3InitModule from '@sqlite.org/sqlite-wasm';\r\n\r\n// https://www.npmjs.com/package/@sqlite.org/sqlite-wasm\r\n// https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\r\n\r\nexport const name = \"sqlite\";\r\n\r\nconst workers = {};\r\n\r\nfunction initalizeWorker(name) {\r\n    let worker = new Worker(new URL('./sqliteWorker.js', import.meta.url), { type: 'module' });\r\n    if (workers[name]) {\r\n        console.error(\"InstantiationError: already taken\");\r\n        worker.terminate();\r\n    } else {\r\n        workers[name] = worker;\r\n    }\r\n}\r\n\r\nexport function createDB(name = 'default') {\r\n    return new Promise((resolve, reject) => {\r\n        initalizeWorker(name);\r\n        let worker = getWorker(name);\r\n        worker.onmessage = function ({ data }) {\r\n            const { type, message } = data;\r\n            if (type === 'created') {\r\n                resolve({ message });\r\n            }\r\n        }\r\n        worker.onerror = (error) => {\r\n            reject(new Error(error));\r\n        };\r\n        worker.postMessage({ action: 'createDB', name });\r\n    });\r\n}\r\n\r\nexport async function deleteAndTerminateDB(name) {\r\n    var root = await navigator.storage.getDirectory();\r\n    let fileSystemFileHandle = await root.getFileHandle(`${name}.sqlite3`);\r\n    if (fileSystemFileHandle) {\r\n        let worker = workers[name];\r\n        worker.onmessage = async function ({ data }) {\r\n            const { type } = data;\r\n            if (type === 'closed') {\r\n                console.log(\"Removing...\", fileSystemFileHandle);\r\n                await fileSystemFileHandle.remove();\r\n                await worker.terminate();\r\n            }\r\n            delete workers[name];\r\n        }\r\n        worker.postMessage({ action: 'closeDB' });\r\n    }\r\n}\r\n\r\nexport function downloadDB(name = 'default') {\r\n    let worker = workers[name];\r\n    if (worker) {\r\n        worker.onmessage = function ({ data }) {\r\n            const { type } = data;\r\n            if (type === 'application/vnd.sqlite3') {\r\n                let downloadChannel = new BroadcastChannel(\"download_channel\");\r\n                downloadChannel.postMessage(data);\r\n                downloadChannel.close();\r\n            }\r\n        }\r\n        worker.postMessage({ action: 'downloadDB' });\r\n    }\r\n}\r\n\r\nexport function executeQuery(sql, name = 'default') {\r\n    return new Promise((resolve, reject) => {\r\n        let worker = getWorker(name);\r\n        if (worker) {\r\n            worker.onmessage = function ({ data }) {\r\n                const { type } = data;\r\n                if (type === 'application/json') {\r\n                    const { result } = data;\r\n                    resolve(result);\r\n                }\r\n            }\r\n            worker.onerror = (error) => {\r\n                reject(error);\r\n            };\r\n            worker.postMessage({ action: \"executeQuery\", sql });\r\n        } else {\r\n            reject(new Error(\"No worker\"));\r\n        }\r\n    });\r\n}\r\n\r\nexport function executeStatement({ sql, values, name = \"default\" }) {\r\n    return new Promise((resolve, reject) => {\r\n        let worker = getWorker(name);\r\n        if (worker) {\r\n            worker.onmessage = function ({ data }) {\r\n                const { type } = data;\r\n                if (type === 'application/json') {\r\n                    const { result } = data;\r\n                    resolve(result);\r\n                }\r\n            }\r\n            worker.onerror = (error) => {\r\n                reject(error);\r\n            };\r\n            worker.postMessage({ action: \"prepareStatement\", sql, values });\r\n        } else {\r\n            reject(new Error(\"No worker\"));\r\n        }\r\n    });\r\n}\r\n\r\nexport function getWorker(name = 'default') {\r\n    let worker = workers[name];\r\n    return worker ? worker : undefined;\r\n}\r\n\r\nexport function getWorkers() {\r\n    return workers;\r\n}\r\n\r\nexport function uploadDB(fileName, arrayBuffer) {\r\n    let [name, extension] = fileName.split(\".\");\r\n    if (['sqlite', 'sqlite3'].includes(extension)) {\r\n        let worker = workers[name];\r\n        if (!worker) {\r\n            initalizeWorker(name);\r\n            worker = getWorker(name);\r\n            console.log({worker})\r\n        } // TODO: allow overwrite\r\n        worker.postMessage({ action: 'uploadDB', name, arrayBuffer });\r\n    } else {\r\n        throw new Error({ name: \"UnsupportedError\", message: \"Unsupported extension\" });\r\n    }\r\n}\r\n\r\nexport function terminate(name = 'default') {\r\n    let worker = workers[name];\r\n    if (worker) {\r\n        worker.postMessage({ command: 'terminate' });\r\n    } \r\n}\r\n\r\nif (window.Worker) {\r\n    try {\r\n        // instantiation test\r\n        const sqlite3 = await sqlite3InitModule({ print: console.log, printErr: console.error });\r\n        console.log('Running SQLite3 version', sqlite3.version.libVersion);\r\n    } catch (err) {\r\n        console.error('Initialization error:', err.name, err.message);\r\n    }\r\n} else {\r\n    console.error('Your browser doesn\\'t support web workers.');\r\n}\r\n"],
  "mappings": "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",
  "names": ["name"]
}
